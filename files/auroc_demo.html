<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Threshold Trade-Off</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    
    <!-- Load Chart.js Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        canvas {
            cursor: crosshair;
        }
        
        /* Remove default number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  
           opacity: 1;
        }
    </style>
</head>
<body class="h-full flex flex-col antialiased text-slate-800">

    <!-- Header with Data Controls -->
    <header class="bg-white shadow-sm z-10 relative">
        <div class="max-w-6xl mx-auto px-6 py-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                    <span class="bg-blue-600 text-white p-1 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </span>
                    The Threshold Trade-Off
                </h1>
                <p class="text-sm text-slate-500 mt-1">Explore how data quality and decision thresholds impact clinical AI.</p>
            </div>
            
            <!-- Global Data Controls -->
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 flex flex-wrap gap-4 items-center text-sm">
                <span class="font-semibold text-slate-700 uppercase text-xs tracking-wider">Simulation Data:</span>
                
                <div class="flex items-center gap-2">
                    <label for="separationInput" class="text-slate-600">Model Ability:</label>
                    <select id="separationInput" class="bg-white border border-slate-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="0.5">Poor (Hard overlap)</option>
                        <option value="1.5" selected>Good (Typical)</option>
                        <option value="3.0">Excellent (Clear separation)</option>
                    </select>
                </div>

                <div class="flex items-center gap-2">
                    <label for="prevalenceInput" class="text-slate-600">Prevalence:</label>
                    <div class="flex items-center bg-white border border-slate-300 rounded overflow-hidden">
                        <input id="prevalenceInput" type="number" min="1" max="50" value="20" class="w-12 px-2 py-1 outline-none text-center">
                        <span class="bg-slate-100 px-2 py-1 text-slate-500 border-l border-slate-300">%</span>
                    </div>
                </div>
                
                <button id="regenerateBtn" class="bg-white hover:bg-slate-100 text-blue-600 border border-blue-200 font-medium px-3 py-1 rounded transition-colors text-xs uppercase tracking-wide">
                    Regenerate Patients
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-6xl w-full mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 items-start h-full p-6">

        <!-- === LEFT COLUMN: ROC Curve Visualization === -->
        <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-slate-200 h-full min-h-[500px] flex flex-col overflow-hidden p-6">
            
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wide">Receiver Operating Characteristic</h2>
                <div class="text-right">
                    <span class="text-xs text-slate-400 uppercase font-bold tracking-wider">AUROC</span>
                    <span id="aurocValue" class="text-xl font-bold text-blue-600 leading-none">0.00</span>
                </div>
            </div>
            
            <div class="relative flex-1 min-h-0">
                <canvas id="rocChart"></canvas>
            </div>

        </div>

        <!-- === RIGHT COLUMN: Controls & Metrics === -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Threshold Control -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <label for="thresholdSlider" class="text-base font-bold text-slate-700">Threshold</label>
                    <input id="thresholdNumber" type="number" min="0" max="1" step="0.01" value="0.50" class="w-20 text-right font-mono text-lg border-b-2 border-slate-200 focus:border-blue-500 outline-none text-blue-600">
                </div>
                
                <input id="thresholdSlider" type="range" min="0" max="1" step="0.01" value="0.5" class="w-full h-3 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                
                <div class="flex justify-between text-xs font-medium text-slate-400 mt-2">
                    <span>0.0 (Loose)</span>
                    <span>1.0 (Strict)</span>
                </div>
            </div>

            <!-- Metrics Pane -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-base font-bold text-slate-800 mb-6">Performance Metrics</h3>
                <div class="space-y-5">
                    
                    <!-- Sensitivity -->
                    <div>
                        <div class="flex justify-between text-sm mb-1.5">
                            <span class="font-medium text-slate-600">Sensitivity</span>
                            <span id="sensitivityValue" class="font-bold text-slate-900">0.0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div id="sensBar" class="bg-blue-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Specificity -->
                    <div>
                        <div class="flex justify-between text-sm mb-1.5">
                            <span class="font-medium text-slate-600">Specificity</span>
                            <span id="specificityValue" class="font-bold text-slate-900">0.0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div id="specBar" class="bg-indigo-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Precision -->
                    <div>
                        <div class="flex justify-between text-sm mb-1.5">
                            <span class="font-medium text-slate-600">Precision</span>
                            <span id="precisionValue" class="font-bold text-slate-900">0.0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div id="precBar" class="bg-violet-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Accuracy -->
                    <div>
                        <div class="flex justify-between text-sm mb-1.5">
                            <span class="font-medium text-slate-600">Accuracy</span>
                            <span id="accuracyValue" class="font-bold text-slate-900">0.0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div id="accBar" class="bg-emerald-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- F1 Score -->
                    <div>
                        <div class="flex justify-between text-sm mb-1.5">
                            <span class="font-medium text-slate-600">F1 Score</span>
                            <span id="f1Value" class="font-bold text-slate-900">0.0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div id="f1Bar" class="bg-amber-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                </div>
            </div>
            
        </div>
    </main>

    <script>
        // === CONFIG ===
        let patients = [];
        const numPatients = 1000;
        let rocChart;
        let rocPoints = [];
        
        // DOM Elements
        const slider = document.getElementById('thresholdSlider');
        const numberInput = document.getElementById('thresholdNumber');
        const aurocEl = document.getElementById('aurocValue');
        
        const separationInput = document.getElementById('separationInput');
        const prevalenceInput = document.getElementById('prevalenceInput');
        const regenerateBtn = document.getElementById('regenerateBtn');
        
        const sensitivityEl = document.getElementById('sensitivityValue');
        const specificityEl = document.getElementById('specificityValue');
        const precisionEl = document.getElementById('precisionValue');
        const accuracyEl = document.getElementById('accuracyValue');
        const f1El = document.getElementById('f1Value');

        // === 1. DATA GENERATION ===
        function generateData() {
            patients = [];
            // Get values from inputs
            const prevalence = parseInt(prevalenceInput.value) / 100;
            const separation = parseFloat(separationInput.value);
            
            const numPositive = Math.floor(numPatients * prevalence);
            const numNegative = numPatients - numPositive;

            function randn_bm() {
                let u = 0, v = 0;
                while(u === 0) u = Math.random();
                while(v === 0) v = Math.random();
                return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
            }

            // Healthy Dist: Mean 0.3
            for(let i=0; i<numNegative; i++) {
                let val = 0.3 + (randn_bm() * 0.15); 
                val = Math.max(0, Math.min(1, val));
                patients.push({ actual: 0, prob: val });
            }

            // Sick Dist: Mean depends on separation
            let sickMean = 0.45;
            if(separation === 1.5) sickMean = 0.7;
            if(separation === 3.0) sickMean = 0.85;

            for(let i=0; i<numPositive; i++) {
                let val = sickMean + (randn_bm() * 0.15);
                val = Math.max(0, Math.min(1, val));
                patients.push({ actual: 1, prob: val });
            }
        }

        // === 2. METRICS & CURVES ===
        function calculateMetrics(threshold) {
            let tp = 0, fp = 0, tn = 0, fn = 0;
            
            for(let p of patients) {
                if(p.prob >= threshold) {
                    if(p.actual === 1) tp++;
                    else fp++;
                } else {
                    if(p.actual === 1) fn++;
                    else tn++;
                }
            }

            const sens = (tp + fn) > 0 ? tp / (tp + fn) : 0;
            const spec = (tn + fp) > 0 ? tn / (tn + fp) : 0;
            const prec = (tp + fp) > 0 ? tp / (tp + fp) : 0;
            const acc = (tp + tn + fp + fn) > 0 ? (tp + tn) / (tp + tn + fp + fn) : 0;
            const fpr = 1 - spec;
            const f1 = (prec + sens) > 0 ? 2 * (prec * sens) / (prec + sens) : 0;

            return { tp, fp, tn, fn, sens, spec, prec, acc, fpr, f1, threshold };
        }

        function calculateCurves() {
            rocPoints = [];
            
            for(let i=0; i<=100; i++) {
                const t = i/100;
                const m = calculateMetrics(t);
                rocPoints.push({ x: m.fpr, y: m.sens, t: t });
            }
            
            rocPoints.sort((a,b) => a.x - b.x); 
            
            // AUC Calculation
            let auc = 0;
            for(let i=1; i<rocPoints.length; i++) {
                auc += (rocPoints[i].x - rocPoints[i-1].x) * (rocPoints[i].y + rocPoints[i-1].y) / 2;
            }
            aurocEl.textContent = auc.toFixed(2);
        }

        // === 3. CHARTS ===
        function initCharts() {
            // ROC
            const rocCtx = document.getElementById('rocChart').getContext('2d');
            rocChart = new Chart(rocCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'ROC Curve',
                            data: rocPoints,
                            borderColor: '#3b82f6',
                            borderWidth: 3,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            showLine: true,
                            fill: true,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Current',
                            data: [],
                            backgroundColor: '#ef4444',
                            pointRadius: 8,
                            pointBorderColor: 'white',
                            pointBorderWidth: 3,
                            hitRadius: 10,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            type: 'linear', min: 0, max: 1, 
                            title: { display: true, text: 'False Positive Rate (1 - Specificity)', font: {weight: 'bold'} },
                            grid: { color: '#f1f5f9' }
                        },
                        y: { 
                            type: 'linear', min: 0, max: 1.0, 
                            title: { display: true, text: 'True Positive Rate (Sensitivity)', font: {weight: 'bold'} },
                            grid: { color: '#f1f5f9' }
                        }
                    }
                }
            });

            setupChartDrag(rocChart, rocPoints);
        }

        // === 4. UI UPDATE ===
        function updateUI(threshold) {
            threshold = Math.max(0, Math.min(1, threshold));
            
            slider.value = threshold;
            numberInput.value = threshold.toFixed(2);
            
            const m = calculateMetrics(threshold);
            
            // Update Text
            sensitivityEl.textContent = (m.sens * 100).toFixed(1) + '%';
            specificityEl.textContent = (m.spec * 100).toFixed(1) + '%';
            precisionEl.textContent = (m.prec * 100).toFixed(1) + '%';
            accuracyEl.textContent = (m.acc * 100).toFixed(1) + '%';
            f1El.textContent = (m.f1 * 100).toFixed(1) + '%';
            
            // Update Bars
            document.getElementById('sensBar').style.width = (m.sens * 100) + '%';
            document.getElementById('specBar').style.width = (m.spec * 100) + '%';
            document.getElementById('precBar').style.width = (m.prec * 100) + '%';
            document.getElementById('accBar').style.width = (m.acc * 100) + '%';
            document.getElementById('f1Bar').style.width = (m.f1 * 100) + '%';
            
            // Update Dots
            rocChart.data.datasets[1].data = [{ x: m.fpr, y: m.sens }];
            rocChart.update('none');
        }

        // === 5. INTERACTION & SETUP ===
        function setupChartDrag(chart, points) {
            const canvas = chart.canvas;
            
            const handleDrag = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                const valX = chart.scales.x.getValueForPixel(x);
                const valY = chart.scales.y.getValueForPixel(y);
                
                let closest = null; 
                let minDst = Infinity;
                
                for(let p of points) {
                    const dx = p.x - valX;
                    const dy = p.y - valY;
                    const dst = dx*dx + dy*dy;
                    if(dst < minDst) {
                        minDst = dst;
                        closest = p;
                    }
                }
                
                if(closest) updateUI(closest.t);
            };

            let dragging = false;
            canvas.addEventListener('mousedown', (e) => { dragging = true; handleDrag(e); });
            window.addEventListener('mousemove', (e) => { if(dragging) handleDrag(e); });
            window.addEventListener('mouseup', () => dragging = false);
            
            canvas.addEventListener('touchstart', (e) => { dragging = true; handleDrag(e); e.preventDefault(); }, {passive: false});
            window.addEventListener('touchmove', (e) => { if(dragging) handleDrag(e); }, {passive: false});
            window.addEventListener('touchend', () => dragging = false);
        }
        
        function init() {
            generateData();
            calculateCurves();
            initCharts();
            updateUI(0.5);

            slider.addEventListener('input', (e) => updateUI(parseFloat(e.target.value)));
            numberInput.addEventListener('change', (e) => updateUI(parseFloat(e.target.value)));
            
            // Data controls listeners
            regenerateBtn.addEventListener('click', () => {
                generateData();
                calculateCurves();
                rocChart.data.datasets[0].data = rocPoints;
                rocChart.update();
                updateUI(parseFloat(slider.value));
            });
            
            separationInput.addEventListener('change', () => regenerateBtn.click());
            prevalenceInput.addEventListener('change', () => regenerateBtn.click());
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>